# Venom Test Suite definition
# Check Venom documentation for more information : https://github.com/ovh/venom
name: run xixo
testcases:
  - name: no arguments
    steps:
      - script: xixo
        assertions:
          - result.code ShouldEqual 0

  - name: simple inputs
    steps:
      - script: echo '<root><element1>innerText</element1></root>' | xixo
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldEqual <root><element1>innerText</element1></root>

  - name: simple inputs and subscribers
    steps:
      - script: echo '<root><element1>innerTexta</element1></root>' | xixo --subscribers root='tee /tmp/debug | tr a b | tee /tmp/debugout '
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
          - result.systemout ShouldContainSubstring  innerTextb

  - name: copy users
    steps:
      - script: cat ../data/users.xml | xixo > ../workspace/users.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: diff ../data/users.xml ../workspace/users.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
          - result.systemout ShouldBeEmpty

  - name: copy users with attributs
    steps:
      - script: cat ../data/users_with_attributs.xml | xixo > ../workspace/users_with_attributs.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: diff ../data/users_with_attributs.xml ../workspace/users_with_attributs.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
          - result.systemout ShouldBeEmpty

  - name: foo bar example
    steps:
      - script: cat ../data/foo_bar_baz.xml | xixo  --subscribers foo="tee ../workspace/debug_foo_bar_baz_input.jsonl | jq --unbuffered -c '.bar |= ascii_upcase' " > ../workspace/foo_bar_baz.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
      - script: diff ../data/foo_bar_baz_expected.xml ../workspace/foo_bar_baz.xml
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
          - result.systemout ShouldBeEmpty
      - script: diff ../data/debug_foo_bar_baz_input_expected.jsonl ../workspace/debug_foo_bar_baz_input.jsonl
        assertions:
          - result.code ShouldEqual 0
          - result.systemerr ShouldBeEmpty
          - result.systemout ShouldBeEmpty

  # - name: copy stream content of user entities in users.xml
  #   steps:
  #     - script: cat ../data/users.xml | xixo --subscribers user=cat > ../workspace/users.xml
  #       assertions:
  #         - result.code ShouldEqual 0
  #         - result.systemerr ShouldBeEmpty
  #     - script: diff ../data/users.xml ../workspace/users.xml
  #       assertions:
  #         - result.code ShouldEqual 0
  #         - result.systemerr ShouldBeEmpty
  #         - result.systemout ShouldBeEmpty
